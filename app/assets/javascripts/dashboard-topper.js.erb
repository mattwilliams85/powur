'use strict';

// dashboard-topper.js
// functions for populating the top section of the dashboard

var DashboardTopper = {
  // function to fill first name in Welcome, [first_name] line
  fillFirstName: function() {
    $('#aw-first-name').text(_data.currentUser.first_name);
  },

  // function to fill in avatar
  fillAvatar: function() {
    if(_data.currentUser.avatar) $('#aw-avatar').attr('src', _data.currentUser.avatar.thumb);
  },

  // function to fill news items feed
  // parameter _lastID is the ID of the last post shown on the page,
  // so the function knows where to start when getting more posts
  fillNewsItems: function(_lastID) {
    _ajax({
        _ajaxType:'get',
        _url:'/u/notifications',
        _callback:function(data){
          _data.notifications = data;
          EyeCueLab.UX.getTemplate(
            '<%= asset_path("hb_templates/auth/notifications/_list.handlebars.html") %>',
            _data.notifications,
            $('#aw-news-notifications'),
            function(){
              $('#aw-news').animate({'opacity': 1}, 200);
            }
          );
        }
    });

    // Wire up Load More button
    $(document).on('click','.aw-news-load-more', function(e) {
      e.stopPropagation();
      e.preventDefault();

      var _nextPage = (_data.notifications.properties.paging.current_page) + 1;

      $('.aw-news-load-more').remove();

      // Populate _data with next page
        _ajax({
            _ajaxType:'get',
            _url:'/u/notifications?page=' + _nextPage,
            _callback:function(data){
              _data.notifications = data;
              EyeCueLab.UX.getTemplate(
                '<%= asset_path("hb_templates/auth/notifications/_list.handlebars.html") %>',
                _data.notifications,
                undefined,
                function(_returnHTML){
                  $('#aw-news-notifications').append(_returnHTML);

                  // If no more posts, remove the "Load More" button
                  if (_data.notifications.entities.length === 0) $('.aw-news-load-more').remove();
                }
              );
            }
        });
    });
  },

  // function to fill pay period goals from _data
  fillPayPeriodGoals: function() {
    _ajax({
      _ajaxType:'get',
      _url:'/u/users/'+_data.currentUser.id+'/goals',
      _callback:function(data){
        if(!data.entities[0].entities.length) return;
        console.log(data)
        var _personalData = data.entities[0],
            _goalData = data.entities[1],
            _currentGoals = {
              personal: [],
              group: []
            },
            total,
            current;
        var rank = $.grep(_goalData.entities, function(e) { return e.properties.id === data.properties.next_rank })[0];
        $.each(rank.entities[0].entities, function(i, qualification) {
          if (qualification.properties.type_display === "Personal Sales") {
            _currentGoals.personal.push(qualification);
          } else { 
            _currentGoals.group.push(qualification);
          }
        });

        if(_currentGoals.personal.length) calculateRankProgress(_currentGoals.personal, _personalData, "personal");
        if(_currentGoals.group.length) calculateRankProgress(_currentGoals.group, _personalData, "group");

        function calculateRankProgress(currentGoals, personalData, type) {
          var personalProducts = {},
          product;
          total = 0;
          current = 0;

          $.each(currentGoals, function(i, goal) {
            personalProducts[String(goal.properties.product_id)] = goal.properties;
            total += goal.properties.quantity;
          });

          $.each(personalData.entities, function(i, order_totals) {
            var productID = String(order_totals.properties.product_id);
            if(productID in personalProducts) {
              if(type === "personal") {
                current += order_totals.properties.personal;
              } else {
                current += order_totals.properties.group;
              }
            }
          });
          if(current > total) current = total;
          var percentage = (current / total)*100

          $('#'+type+'_rooftops_tooltip').text(current+' of '+total+' '+type+' Rooftops');
          $('#'+type+'_rooftops .highlight_container .highlight').animate({'width':percentage+'%'}, 1000);
        }
        $('.aw-tooltip').fadeIn();
      }
    });
  },

  // function to get inspirational quote to share at bottom of dashboard topper
  fillShareQuote: function() {
    // share quotes will eventually be populated by a backend source:
    // var _shareQuotes = _data.dashboard_topper.share_quotes

    var _shareQuotes = [
      'The solar revolution has begun. Powur is leading the way by empowering' +
      ' everyday heroes. Find out more about this compelling opportunity.',
      'We\'re cutting yearly energy costs by thousands of dollars for homeowners across' +
      ' the United States. Powur advocates are helping us save the world with sunshine.',
      'Turn a sunny day into a sustainable future. Join Powur and start taking back' +
      ' the future of energy!'
      ];
    var _randomIndex = Math.floor((Math.random() * _shareQuotes.length));
    $('.aw-share-quote').text(_shareQuotes[_randomIndex]);
  },

  fadeOutLoader: function() {
    $('.aw-spinner').hide();
  },

  fadeItIn: function() {
    $('.aw-fade-in').animate({'opacity':'1'}, 500);
  },

  // function to run all of the above
  readyGO: function() {
    this.fillFirstName();
    this.fillAvatar();
    this.fillNewsItems();
    this.fillPayPeriodGoals();
    this.fillShareQuote();
    this.fadeOutLoader();
    this.fadeItIn();
  },

};