'use strict';

var sunstandApp = angular.module('sunstandApp', [
  'ngRoute',

  'sunstandControllers',
  'sunstandServices',

  // Directives
  // 'sunstandApp.signInForm',
  // 'sunstandApp.fileS3Uploader'
]).run(['$rootScope', '$location', '$document', '$http', 'CurrentUser',
  function ($rootScope, $location, $document, $http, CurrentUser) {
    $rootScope.currentUser = {};
    $rootScope.isSignedIn = !!SignedIn;

    /*
     * Fill in User object with data if user is signed in but object is empty
    */
    $rootScope.$on('$includeContentLoaded', function(event, next, current) {
      if ($rootScope.isSignedIn) {
        CurrentUser.get().then(function(data) {
          $rootScope.currentUser = data;
        });
      }
    });

    $rootScope.redirectToDashboardIfSignedIn = function() {
      if ($rootScope.isSignedIn) {
        window.location = '/u/dashboard';
      }
    };

    $rootScope.redirectUnlessSignedIn = function() {
      if (!$rootScope.isSignedIn) {
        window.location = '#/sign-in';
      }
    };

    // TODO: move header functionality into its own directive
    $rootScope.invertHeaderColor = function() {
      var docEl = document.documentElement,
      header,
      height = $(window).height() - 20;
      window.onscroll = function headerScrollInvert() {
        var sTop = (this.pageYOffset || docEl.scrollTop) - (docEl.clientTop || 0);
        header = document.getElementById('sun_header_guest');

        if (!header) return;

        if (sTop > height) {
          if (header.className !== 'sun-header-guest invert') {
            header.setAttribute('class', 'sun-header-guest hidden');
            setTimeout(function invertHeader() {
              header.setAttribute('class', 'sun-header-guest invert');
            }, 200);
          }
        } else {
          if (header.className !== '') {
            header.setAttribute('class', 'sun-header-guest hidden');
            setTimeout(function invertHeader() {
              header.setAttribute('class', 'sun-header-guest');
            }, 200);
          }
        }
      };
    };

    // TODO: move header functionality into its own directive
    $rootScope.signOut = function() {
      var cb = function() {
        $rootScope.isSignedIn = false;
        window.location = '#/sign-in';
      };
      $http.delete('/login.json', {
        xsrfHeaderName: 'X-CSRF-Token'
      }).success(cb).error(cb);
    };

    $rootScope.gotoAnchor = function(id) {
      var duration = 500;
      var offset = 0; // pixels; adjust for floating menu, context etc
      // Scroll to #some-id with N px "padding"
      var someElement = angular.element(document.getElementById(id));
      $document.scrollToElement(someElement, offset, duration);
    };
  }
]);

var sunstandControllers = angular.module(
  'sunstandControllers',
  []
);
var sunstandServices = angular.module(
  'sunstandServices',
  ['ngResource', 'uiSlider', 'duScroll']
);


sunstandApp.config(
  ['$routeProvider', '$sceProvider', function($routeProvider, $sceProvider) {
    $sceProvider.enabled(false);

    $routeProvider.
    when('/home', {
      templateUrl: '<%=asset_path("angular/landing/templates/index.html")%>',
      controller: 'LandingCtrl'
    }).
    when('/sign-in', {
      templateUrl: '<%=asset_path("angular/landing/templates/sign-in.html")%>',
      controller: 'LandingCtrl'
    }).
    when('/reset-password', {
      templateUrl: '<%=asset_path("angular/landing/templates/reset-password.html")%>',
      controller: 'LandingCtrl'
    }).
    when('/edit-password/:resetPasswordToken', {
      templateUrl: '<%=asset_path("angular/landing/templates/edit-password.html")%>',
      controller: 'LandingCtrl'
    }).

    // FAQ
    when('/customer-faq', {
      templateUrl: '<%=asset_path("angular/landing/templates/customer-faq.html")%>',
      controller: 'LandingCtrl'
    }).
    when('/advocate-faq', {
      templateUrl: '<%=asset_path("angular/landing/templates/advocate-faq.html")%>',
      controller: 'LandingCtrl'
    }).

    // Promo
    when('/create-wealth', {
      templateUrl: '<%=asset_path("angular/promo/templates/create-wealth.html")%>',
      controller: 'PromoCtrl'
    }).
    when('/create-energy', {
      templateUrl: '<%=asset_path("angular/promo/templates/create-energy.html")%>',
      controller: 'PromoCtrl'
    }).

    // University
    when('/university', {
      templateUrl: '<%=asset_path("angular/university/templates/index.html")%>',
      controller: 'UniversityCtrl'
    }).

    otherwise({
      redirectTo: '/home'
    });
  }]
);
