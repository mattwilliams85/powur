
'use strict';

function PromoCtrl($scope, $location, $timeout, $interval, $window) {
  $scope.redirectToDashboardIfSignedIn();
  $scope.removePiler();

  $scope.isMenuActive = false;
  $scope.hideMenuClick = function() {
    $scope.isMenuActive = false;
  };
  $scope.showMenuClick = function() {
    $scope.isMenuActive = true;
  };

  $scope.stopSlideShowOn = function(slide) {
    $scope.currentSlide = $scope.energySlides.indexOf(slide);
    $interval.cancel($scope.sliderStop);
    $scope.sliderStop = undefined;
  };

  $scope.energySlides = [
    {
      images: [
        'http://lorempixel.com/200/200/nature/1/',
        'http://lorempixel.com/200/200/nature/2/',
        '<%=asset_url("promo/slide-show-item.jpg") %>'
      ],
      text: 'Lock in a low rate on your electricity for the next 20 years, effectively guaranteeing no more price increases, or inflation costs for energy!'
    },
    {
      images: [
        'http://lorempixel.com/200/200/nature/3/',
        'http://lorempixel.com/200/200/nature/4/',
        '<%=asset_url("promo/slide-show-item.jpg") %>'
      ],
      text: 'Lock in a low rate on your electricity for the next 20 years, effectively guaranteeing no more price increases, or inflation costs for energy!'
    },
    {
      images: [
        'http://lorempixel.com/200/200/nature/5/',
        'http://lorempixel.com/200/200/nature/6/',
        '<%=asset_url("promo/slide-show-item.jpg") %>'
      ],
      text: 'Lock in a low rate on your electricity for the next 20 years, effectively guaranteeing no more price increases, or inflation costs for energy!'
    }
  ];

  $scope.setupInvertHeader = function() {
    angular.element($window).bind("scroll", function() {
      var header = document.getElementById('sun_header_guest');
      if (header && header.className !== 'sun-header-guest invert') {
        header.setAttribute('class', 'sun-header-guest hidden');
        setTimeout(function invertHeader() {
          header.setAttribute('class', 'sun-header-guest invert');
        }, 200);
      }
    });
  };

  this.init($scope, $location, $timeout, $interval);
  this.fetch($scope, $interval, $timeout);
}


PromoCtrl.prototype.init = function($scope, $location, $timeout, $interval) {
  $scope.$watch('slider', function(newValue) {
    if (newValue === '1') {
      $('.image-2').animate({opacity:'1'},200)
      $('.image-1').animate({opacity:'0.3'},200)
      $timeout(function() {
        $.fn.pagepiling.moveSectionDown();
      }, 200);
    } else {
      $('.image-2').animate({opacity:'0.3'},200)
      $('.image-1').animate({opacity:'1'},200)
    }
  });

  // Setting mode based on the url
  $scope.mode = 'create-wealth';
  if (/\/create-energy$/.test($location.path())) return $scope.mode = 'create-energy';
  if (/\/why-solar$/.test($location.path())) return $scope.mode = 'why-solar';
  if (/\/our-origin$/.test($location.path())) return $scope.mode = 'our-origin';
};


PromoCtrl.prototype.fetch = function($scope, $interval, $timeout) {
  if ($scope.mode === 'create-wealth') {
    $('.arrow-box').css('bottom','3em');
    $scope.readyPiler();

    // Clock
    $scope.minTime = new Date(2000, 1, 1, 0, 0, 0, 0).valueOf();
    // Max time is 3 minutes
    $scope.maxTime = new Date(2000, 1, 1, 0, 0, 0, 0).valueOf() + (1000 * 60 * 3);
    $scope.solarTime = $scope.maxTime;
    $scope.solarTimerSeconds = '00';
    $scope.solarTimerMinutes = '03';
    $scope.solarTimerHours = '00';
    $scope.solarTimerPeople = 0;
    var timeStrings;
    $scope.solarTimerStop = $interval(function() {
      $scope.solarTime -= 1000;
      timeStrings = new Date($scope.solarTime).toTimeString().split(':');
      $scope.solarTimerHours = timeStrings[0];
      $scope.solarTimerMinutes = timeStrings[1];
      $scope.solarTimerSeconds = /^[\d]{2}/.exec(timeStrings[2])[0];
      if ($scope.solarTime === $scope.minTime) {
        $scope.solarTimerPeople += 1;
        $scope.solarTime = $scope.maxTime;
      }
    }, 1000);
  } else if ($scope.mode === 'create-energy') {
    var pilerTimer = $timeout(function() {
      $('.arrow-box').animate({
        bottom: "3em"
      }, 500, "easeOutBounce" );
    }, 3000);

    // Cancels if user leaves page
    $scope.$on('$locationChangeStart', function(){
      $timeout.cancel(pilerTimer);
    });
    $scope.readyPiler();

    $scope.currentSlide = 0;
    $scope.sliderStop = $interval(function() {
      if ($scope.currentSlide >= $scope.energySlides.length - 1) {
        $scope.currentSlide = 0;
      } else {
        $scope.currentSlide += 1;
      }
    }, 3000);
  } else if ($scope.mode === 'why-solar') {
    $scope.readyPiler();
  } else if ($scope.mode === 'our-origin') {
    $scope.setupInvertHeader();
  }
};


PromoCtrl.$inject = ['$scope', '$location', '$timeout', '$interval', '$window'];
sunstandControllers.controller('PromoCtrl', PromoCtrl);
