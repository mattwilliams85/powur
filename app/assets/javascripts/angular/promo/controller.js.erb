'use strict';

function PromoCtrl($scope, $location, $timeout, $interval, $window, $anchorScroll) {
  $scope.redirectToDashboardIfSignedIn();
  $scope.removePiler();

  $scope.isMenuActive = false;
  $scope.hideMenuClick = function() {
    $scope.isMenuActive = false;
  };
  $scope.showMenuClick = function() {
    $scope.isMenuActive = true;
  };

  $scope.setupPromoSlider = function(slides) {
    $scope.promoSlides = slides;
    $scope.currentSlide = 0;
    $scope.sliderStop = $interval(function() {
      if ($scope.currentSlide >= $scope.promoSlides.length - 1) {
        $scope.currentSlide = 0;
      } else {
        $scope.currentSlide += 1;
      }
    }, 6000);
  };

  $scope.animateArrow = function(id){
    var pilerTimer = $timeout(function() {
      $(id).animate({
        bottom: "3em"
      }, 500, "easeOutBounce" );
    }, 3000);
  }

  $scope.stopSlideShowOn = function(slide) {
    if (slide === parseInt(slide, 10)) { // check if integer
      $scope.currentSlide = slide;
    } else {
      $scope.currentSlide = $scope.promoSlides.indexOf(slide);
    }
    $interval.cancel($scope.sliderStop);
    $scope.sliderStop = undefined;
  };

  // $scope.promoSlides = [];

  $scope.energyPromoSlides = [
    {
      images: [
        'http://lorempixel.com/200/200/nature/1/',
        'http://lorempixel.com/200/200/nature/2/',
        '<%=asset_url("promo/slide-show-item.jpg") %>'
      ],
      text: 'Lock in a low rate on your electricity for the next 20 years, effectively guaranteeing no more price increases, or inflation costs for energy!'
    },
    {
      images: [
        'http://lorempixel.com/200/200/nature/3/',
        'http://lorempixel.com/200/200/nature/4/',
        '<%=asset_url("promo/slide-show-item.jpg") %>'
      ],
      text: 'Lock in a low rate on your electricity for the next 20 years, effectively guaranteeing no more price increases, or inflation costs for energy!'
    },
    {
      images: [
        'http://lorempixel.com/200/200/nature/5/',
        'http://lorempixel.com/200/200/nature/6/',
        '<%=asset_url("promo/slide-show-item.jpg") %>'
      ],
      text: 'Lock in a low rate on your electricity for the next 20 years, effectively guaranteeing no more price increases, or inflation costs for energy!'
    }
  ];

  $scope.directSalePromoSlides = [
    {
      images: [
        'http://lorempixel.com/200/200/nature/1/',
        'http://lorempixel.com/200/200/nature/2/',
        'http://lorempixel.com/200/200/nature/9/'
      ],
      text: 'There is no industry as good at spreading products via word of mouth as ours.  Despite the often misunderstood nature of direct sales, the numbers don’t lie.  Direct sales has the potential to create millions of solar customers over the next decade… and generate BILLIONS in wealth for those who do.'
    },
    {
      images: [
        'http://lorempixel.com/200/200/nature/3/',
        'http://lorempixel.com/200/200/nature/4/',
        'http://lorempixel.com/200/200/nature/5/'
      ],
      text: 'There is no industry as good at spreading products via word of mouth as ours.  Despite the often misunderstood nature of direct sales, the numbers don’t lie.  Direct sales has the potential to create millions of solar customers over the next decade… and generate BILLIONS in wealth for those who do.'
    },
    {
      images: [
        'http://lorempixel.com/200/200/nature/6/',
        'http://lorempixel.com/200/200/nature/7/',
        'http://lorempixel.com/200/200/nature/8/'
      ],
      text: 'There is no industry as good at spreading products via word of mouth as ours.  Despite the often misunderstood nature of direct sales, the numbers don’t lie.  Direct sales has the potential to create millions of solar customers over the next decade… and generate BILLIONS in wealth for those who do.'
    }
  ];

  this.init($scope, $location, $timeout, $interval, $anchorScroll);
  this.fetch($scope, $interval, $timeout, $anchorScroll, $location);
}


PromoCtrl.prototype.init = function($scope, $location, $timeout, $interval, $anchorScroll) {
  $scope.$watch('slider', function(newValue) {
    if (newValue === '1') {
      $('.image-2').animate({opacity:'1'},200);
      $('.image-1').animate({opacity:'0.3'},200);
      $timeout(function() {
        if ($location.path() === '/create-energy') {
          $.fn.pagepiling.moveSectionDown();
        }
        $scope.gotoAnchor('on_slider_move');
      }, 200);
    } else {
      $('.image-2').animate({opacity:'0.3'},200);
      $('.image-1').animate({opacity:'1'},200);
    }
  });

  // Setting mode based on the url
  $scope.mode = '';
  if (/\/create-wealth$/.test($location.path())) return $scope.mode = 'create-wealth';
  if (/\/create-energy$/.test($location.path())) return $scope.mode = 'create-energy';
  if (/\/why-solar$/.test($location.path())) return $scope.mode = 'why-solar';
  if (/\/why-you$/.test($location.path())) return $scope.mode = 'why-you';
  if (/\/why-powur$/.test($location.path())) return $scope.mode = 'why-powur';
  if (/\/why-direct-selling$/.test($location.path())) return $scope.mode = 'why-direct-selling';
  if (/\/our-origin$/.test($location.path())) return $scope.mode = 'our-origin';
};


PromoCtrl.prototype.fetch = function($scope, $interval, $timeout, $anchorScroll, $location) {
  if ($scope.mode === 'create-wealth') {
    $(window).on('beforeunload', function() {
        $(window).scrollTop(0);
    });
    $('body').addClass('no-scroll')
    $scope.setupInvertHeader();
    // Clock
    $scope.minTime = new Date(2000, 1, 1, 0, 0, 0, 0).valueOf();
    // Max time is 3 minutes
    $scope.maxTime = new Date(2000, 1, 1, 0, 0, 0, 0).valueOf() + (1000 * 60 * 3);
    $scope.solarTime = $scope.maxTime;
    $scope.solarTimerSeconds = '00';
    $scope.solarTimerMinutes = '03';
    $scope.solarTimerHours = '00';
    $scope.solarTimerPeople = 0;
    var timeStrings;
    $scope.solarTimerStop = $interval(function() {
      $scope.solarTime -= 1000;
      timeStrings = new Date($scope.solarTime).toTimeString().split(':');
      $scope.solarTimerHours = timeStrings[0];
      $scope.solarTimerMinutes = timeStrings[1];
      $scope.solarTimerSeconds = /^[\d]{2}/.exec(timeStrings[2])[0];
      if ($scope.solarTime === $scope.minTime) {
        $scope.solarTimerPeople += 1;
        $scope.solarTime = $scope.maxTime;
      }
    }, 1000);
  } else if ($scope.mode === 'create-energy') {
    $scope.animateArrow('#arrow_1')
    // Cancels if user leaves page
    $scope.$on('$locationChangeStart', function() {
      $timeout.cancel(pilerTimer);
    });
    $scope.readyPiler();
    $scope.setupPromoSlider($scope.energyPromoSlides);
  } else if ($scope.mode === 'why-solar') {
    $scope.animateArrow('#arrow_1')
    $scope.readyPiler();
  } else if ($scope.mode === 'why-powur') {
    $scope.readyPiler();
  } else if ($scope.mode === 'why-you') {
    $scope.animateArrow('#arrow_1')
    $scope.readyPiler();

    $scope.currentSlide = 0;
    $timeout(function() {
      $scope.currentSlide += 1;
      $scope.sliderStop = $interval(function() {
        if ($scope.currentSlide >= 3) { $scope.animateArrow('#arrow_2') }
        if ($scope.currentSlide >= 4) {
          $scope.currentSlide = 0;
        } else {
          $scope.currentSlide += 1;
        }
      }, 5000);
    }, 500);
  } else if ($scope.mode === 'why-direct-selling') {
    $scope.animateArrow('#arrow_1')
    $scope.readyPiler();
    $scope.setupPromoSlider($scope.directSalePromoSlides);
  } else if ($scope.mode === 'our-origin') {
    $scope.setupInvertHeader();
  }
};


PromoCtrl.$inject = ['$scope', '$location', '$timeout', '$interval', '$window', '$anchorScroll'];
sunstandControllers.controller('PromoCtrl', PromoCtrl);
