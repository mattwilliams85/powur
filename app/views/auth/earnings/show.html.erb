<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

<% content_for :javascript_includes do %>
  <%= javascript_include_tag "dashboard.js" %>
<% end %>

<section id="dashboard_personal_goals" data-drilldown-level="0">
  <div class="section_header">

    <div class="section_header_content"></div>

    <div id="date-dropdown">
      <div class="section_label">
        <div class="tag"><img src="/images/dashboard/customers_icon.png"></div>
      </div>

      <select class="dropdown" id="startMonth">
        <% @months.each_with_index do |month, index|%>
          <% if index + 1 == Date.today.month %>
            <option value="<%=(index + 1)%>" selected><%=@months[index]%></option>
          <% else %>
            <option value="<%=(index + 1)%>"><%=@months[index]%></option>
          <% end %>
        <% end %>
      </select>

      <select class="dropdown" id="startYear">
        <% @currentYear = Date.today.year %>
        <option value="<%=@currentYear%>" selected><%= @currentYear %></option>
        <% until @currentYear == 2013 %>
          <% @currentYear -= 1%>
          <option value="<%=@currentYear%>"><%=@currentYear%></option>
        <% end %>
      </select>
      <div class="section_label">
        <div class="text">&nbsp;&nbsp;to</div>
      </div>

      <select class="dropdown" id="endMonth">
        <% @months.each_with_index do |month, index|%>
          <% if index + 1 == Date.today.month %>
            <option value="<%=(index + 1)%>" selected><%=@months[index]%></option>
          <% else %>
            <option value="<%=(index + 1)%>"><%=@months[index]%></option>
          <% end %>
        <% end %>
      </select>

      <select class="dropdown" id="endYear">
        <% @currentYear = Date.today.year %>
        <option value="<%=@currentYear%>" selected><%= @currentYear %></option>
        <% until @currentYear == 2013 %>
         <% @currentYear -= 1%>
          <option value="<%=@currentYear%>"><%=@currentYear%></option>
        <% end %>
      </select>
      </div>
    </div> 
  </div>
  <br>
  <br>
  <div class="warning"></div>

  <div class="section_body"></div>

</section>

<br><br><br>


<script type="text/javascript">

var _detailsData = [];
var startYear = (new Date()).getYear() + 1900
var startMonth = (new Date()).getMonth() + 1
var endYear = (new Date()).getYear() + 1900
var endMonth = (new Date()).getMonth() + 1
var currentMonth = 0;
var detailsPage = 1;

_ajax({
  _ajaxType: "get",
  _url: "/u/earnings/summary?format=json&user_id=<%=current_user.id%>&start_year="+startYear+"&start_month="+startMonth+"&end_year="+endYear+"&end_month="+endMonth,
  _callback: function(data, text) {
    if(data.entities.length == 0){
      data.properties.active = false;
    }
      EyeCueLab.UX.getTemplate("/templates/auth/earnings/_header.handlebars.html", data, $(".section_header_content"), function(html) {
    });
  }
});


$(document).ready(function(){

function checkRange(){
  $('.warning').empty()
  var range = endMonth - startMonth + ((endYear - startYear)*12);
  if(range < 0) $('.warning').html("Invalid Date Range")
  else return range + 1;
}

function getEarnings(){
  currentMonth = parseInt(startMonth - 1)
  currentYear = parseInt(startYear)
  var _endPoints =[];
  var range = checkRange()
  for(i=0;i<range;i++){
    if(currentMonth == 12){
      currentMonth = 0
      currentYear += 1
    }

    currentMonth += 1 
    _endPoints.push({
        url:"/u/earnings/summary?format=json&user_id=<%=current_user.id%>&start_year="+startYear+"&start_month="+currentMonth+"&end_year="+startYear+"&end_month="+currentMonth,
        // url:"/u/earnings/summary?format=json&user_id=<%=current_user.id%>&start_year="+2014+"&start_month="+10+"&end_year="+2014+"&end_month="+10,
        data:{},
        name:"Summary"
    });
  }
  EyeCueLab.JSON.asynchronousLoader(_endPoints, function(_returnJSONs){
    _summaryData = EyeCueLab.JSON.getObjectsByPattern(_returnJSONs, {"containsIn(class)":["list", "earnings"]})

    currentMonth = startMonth - 1;
    var currentYear = startYear;
    for(var i = 0; i < _summaryData.length; i++){
        if(currentMonth == 12){
          currentMonth = 0;

          currentYear = parseInt(currentYear) + 1;
        }
      if(_summaryData[i].entities.length === 0){
        _summaryData[i].entities[0] = [] 
        _summaryData[i].entities[0].properties = {
                                                  "pay_period_year":(String(currentYear)),
                                                  "pay_period_month":(String(currentMonth)), 
                                                  "pay_period_type":"Monthly"
                                                 }
        for (var n = 1; n < 5; n++) {
           _summaryData[i].entities[n] = []
           _summaryData[i].entities[n].properties = {
                                                    "pay_period_type":"Weekly",
                                                    "amount":0,
                                                    "pay_period_week_number":(n),
                                                    "pay_period_date_range":"-"
                                                  }
        }
        _summaryData[i].properties.active = false;
      } else {
        // for(var n=0;n<4;n++){
        //   if _summaryData[i].entities[n].
        // }
        _summaryData[i].entities[0].properties.pay_period_month = (String(currentMonth))
        _summaryData[i].entities[0].properties.pay_period_year = (String(currentYear))
      }
      currentMonth += 1 
    }
    
    EyeCueLab.UX.getTemplate("/templates/auth/earnings/_summary.handlebars.html", _summaryData, $(".section_body"), function(html) {
      clickEvents();
    });
  });
}


  function clickEvents(){ 
    $(".dropToggle.weekly").click(function(e){
      if(!$(this).hasClass("active")) {
        e.stopPropagation() 
        $(this).addClass("active")
        row = $(this).parent().parent()
        $("<tr class='temp-row'><td colspan='5' class='dropDownDetails' id='row"+row.index()+"' style='background-color:#333;color:#eee;text-align:left;padding:30px'></td></tr>").insertAfter(row);
        _ajax({
          _ajaxType: "get",
          _url:"/u/earnings/detail?format=json&user_id=1&pay_period_id="+$(this).attr("id"),
          _callback: function(data, text) {
            if(data.entities.length == 0){
              data.properties.active = false;
            }
        EyeCueLab.UX.getTemplate("/templates/auth/earnings/_details.handlebars.html", data, $('#row'+row.index()+''), function(html) {
            });
        $('.dropDownDetails').velocity({height:"330px"}, function(){
          $('.slideTable').fadeIn(400);
        })
          }
        });
      } else {
        $(this).removeClass("active")
        reverseDrop($(this))
      }
    });    

    $(".dropToggle.monthly").click(function(e){
      if(!$(this).hasClass("active")) {
        e.stopPropagation() 
        $(this).addClass("active")
        var pay_period_id = $(this).attr("id")
        var row = $(this).parent().parent()
        $("<tr class='temp-row'><td colspan='5' class='dropDownDetails' id='row"+row.index()+"' style='background-color:#333;color:#eee;text-align:left;padding:30px'></td></tr>").insertAfter(row);
        _ajax({
          _ajaxType: "get",
          _url:"/u/earnings/bonus?format=json&user_id=1&pay_period_id="+pay_period_id,
          _callback: function(data, text) {
          
            if(data.entities.length == 0){
              data.properties.active = false;
            }
        EyeCueLab.UX.getTemplate("/templates/auth/earnings/_bonus.handlebars.html", data, $('#row'+row.index()+''), function(html) {
          secondaryEvents(pay_period_id, row)
            });
        $('.dropDownDetails').velocity({height:"330px"}, function(){
          $('.slideTable').fadeIn(400);
        })
          }
        });
      } else {
        $(this).removeClass("active")
        reverseDrop($(this))
      }
    });    

    function reverseDrop(selected){
      selected = selected.parent().parent().next()
      selected.find('.slideTable td').css("padding","0px");
      selected.find('#slideData').remove()
      selected.find('.dropDownDetails').css("padding","0px");
      selected.find('.dropDownDetails tr').remove()
      selected.find('.dropDownDetails').velocity({height:'0px'}, function(){
        selected.find('.dropDownDetails').remove();
      });
      // dropFlag = false;
    }



    function secondaryEvents(pay_period_id, row){
      $(".dropToggle.summary").click(function(e){
        e.preventDefault()
        e.stopPropagation() 
        var bonus_id = $(this).children().attr("id")
        if(!$(this).hasClass("active")) {
          $(this).addClass("active")
          row = $(this).parent().parent()
          $("<tr class='temp-row'><td colspan='5' class='dropDownDetails' id='subrow"+row.index()+"' style='background-color:#333;color:#eee;text-align:left;padding:30px'></td></tr>").insertAfter(row);

          _ajax({
            _ajaxType: "get",
            _url:"/u/earnings/bonus_detail?format=json&user_id=1&pay_period_id="+pay_period_id+"&bonus_id="+bonus_id+"&page="+detailsPage,
            _callback: function(data, text) {

             
           EyeCueLab.UX.getTemplate("/templates/auth/earnings/_summary_details.handlebars.html", data, $('#subrow'+row.index()+''), function(html) {
            recursiveJquery(data, pay_period_id, bonus_id, row)
          

              });
          data.paginationInfo=_paginateData(_getObjectsByCriteria(data, {name:"page"})[0], {prefix:"js-popup", actionableCount:10});
          data.paginationInfo.templateName="/templates/admin/quotes/popups/_order_totals_listing.handlebars.html",
          data.paginationInfo.templateContainer="#js-popup .js-popup_content_container";
          
          // EyeCueLab.UX.getTemplate("/templates/auth/earnings/_details_listing.handlebars.html", data, undefined, function(html) {

          //    $('#subrow'+row.index()+'').append(html)
          //    console.log("after")
                  // });


          
          $('.dropDownDetails').velocity({height:"330px"}, function(){
            $('.slideTable').fadeIn(400);
          })
            }
          });
        } else {
          $(this).removeClass("active")
          reverseDrop($(this))
        }
      });
    }

  }
  $('.dropdown').on("change",function(){
    startYear = $('#startYear option:selected').val()
    startMonth = $('#startMonth option:selected').val()
    if(startMonth < 10) startMonth = "0" + startMonth
    endYear = $('#endYear option:selected').val()
    endMonth = $('#endMonth option:selected').val()
    if(endMonth < 10) endMonth = "0" + endMonth
    getEarnings();
  })

  function fillHeaders(){

    var months = [ "","January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December" ]
    $('.date').each(function(index, element){
    })
  }

  getEarnings();
})

function recursiveJquery(data, pay_period_id, bonus_id, row){
  $(".js-pagination a").on("click", function(e){
    console.log("click!")
    detailsPage = $(this).attr("data-page-number")
      e.stopPropagation();
      e.preventDefault();
      data.paginationInfo.page= $(e.target).attr("data-page-number")? $(e.target).attr("data-page-number").split(" ")[1]:1;
      _ajax({
        _ajaxType: "get",
        _url:"/u/earnings/bonus_detail?format=json&user_id=1&pay_period_id="+pay_period_id+"&bonus_id="+bonus_id+"&page="+detailsPage,
        _callback: function(data, text) {
          data.paginationInfo=_paginateData(_getObjectsByCriteria(data, {name:"page"})[0], {prefix:"js-popup", actionableCount:10});
          data.paginationInfo.templateName="/templates/admin/quotes/popups/_order_totals_listing.handlebars.html",
          data.paginationInfo.templateContainer="#js-popup .js-popup_content_container";
          EyeCueLab.UX.getTemplate("/templates/auth/earnings/_summary_details.handlebars.html", data, $('#subrow'+row.index()+''), function(html) {
            recursiveJquery(data, pay_period_id, bonus_id, row)
          });
       }
     });
  });
}

</script>
