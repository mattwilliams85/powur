<div class="arrow"></div>
<div class="drilldown_content">
  <div id="kpi_environment_detail" class="object_detail">

    <div class="object_detail_content">
      <div class="object_detail_content_section summary">
        <span class="progress_description">Top Performers</span>
        <a class="return_to_team" style="z-index:99;margin:auto;display:block; display:none; float:left; font-size:16px; text-transform:uppercase;"><i class="fa fa-bar-chart chart-icon"></i>  Return To Team</a>
        <div class="contributors"></div>
        <div class="scroll-arrows">
          <i class="fa fa-caret-up"></i><i class="fa fa-caret-down"></i>
        </div>
      </div>

      <div class="object_detail_content_section" style="padding-left:20px;">
        <span id="graph_title" style="font-size:1.05em">Total Earnings to Date </span>
        <br>
        <div class="legend-box">
          <div class="legend">
            <div class="legend-item" id="user-legend"></div>
            <span id="selected_user" class="legend-text">Team Size</span>
          </div>
          <div class="time_scale" style="padding-left:20px">
            <span class="active week">Week</span><span class="month">Month</span>
          </div>
        </div> <!-- end legend-box -->
        {{!-- <div style="display:block;"> --}}
        <div class="week-span" style="display:block;font-size:0.8em;width:175px;margin:0 auto;text-align:center"></div>
        {{!-- </div> --}}
        <canvas id="metricsChart" width="670" height="330" style="float:left;"></canvas>
        <div class="time_unit_nav">
          <i class="fa fa-caret-left back" style="color:rgb(238,238,238); margin-right:10px;"></i> 
          <span class="current">Current</span> 
          <i class="fa fa-caret-right forward" style="color:rgb(238,238,238); margin-left:10px;"></i>
        </div>
        </div> <!-- end object_detail_content_section -->
        <div class="team_statistics">
        <h3>TEAM STATS</h3>
        <h4>Today</h4>
        <span class="label">Earnings: $350</span>
        <h4>This Week</h4>
        <span class="label">Earnings: $1,500</span>
        <h4 style="padding-top:20px">This Month</h4>
        <span class="label" >Earnings: $2,182.67</span>
      </div> <!-- end team_statistics_box -->
    </div> <!-- end object_detail_content -->
  </div> <!-- end object_detail -->
</div> <!-- end drilldown_content -->

        


<script>

var _labels = [];
var position = 0;
var page = 1;
// var total_pages = Math.ceil(_data.team.entities.length / 5)
var now = new Date()
now = setCalendarWeek()
var nowWeek = (new Date()).getWeek();
var nowMonth = (new Date()).getMonth();
var _endPoints = [];
var scale = "week"
var topPerformers = [];
var currentlyViewing = "team";
var scaleSteps = ""

var teamWeekData = {
                    "sales":[23,24,26,0,0,0,0],
                   };

var teamMonthData = {
                   "sales":[19,20,23,24,26,20,21,22,23,22,21,20,19,17,20,25,26,21,20,20,20,25,25,23,21,23,24,26,0,0,0],
                  };

var metricsData = {
    labels: _labels,
    datasets: [
        {
          label: "My dataset",
          fillColor: "rgba(220,220,0,0)",
          strokeColor: "rgba(32,194,241,1)",
          pointColor: "rgba(32,194,241,1)",
          pointStrokeColor: "#fff",
          pointHighlightFill: "#fff",
          pointHighlightStroke: "rgba(220,220,220,1)",
          data: teamWeekData["sales"]
        }
    ]
};

var options = {
    // Number - pixel width of padding around tooltip text
    tooltipYPadding: 8,

    // Number - pixel width of padding around tooltip text
    tooltipXPadding: 8,

    ///Boolean - Whether grid lines are shown across the chart
    scaleShowGridLines : true,

    scaleFontColor: "rgba(247,239,226,0.8)",

    //String - Colour of the grid lines
    scaleGridLineColor : "rgba(255,255,255,.065)",

    //Number - Width of the grid lines
    scaleGridLineWidth : 1,

    //Boolean - Whether the line is curved between points
    bezierCurve : false,

    //Boolean - Whether to show a dot for each point
    pointDot : true,

    //Number - Radius of each point dot in pixels
    pointDotRadius : 4,

    //Number - Pixel width of point dot stroke
    pointDotStrokeWidth : 1,

    //Number - amount extra to add to the radius to cater for hit detection outside the drawn point
    pointHitDetectionRadius : 20,

    //Boolean - Whether to show a stroke for datasets
    datasetStroke : true,

    //Number - Pixel width of dataset stroke
    datasetStrokeWidth : 3,

    //Boolean - Whether to fill the dataset with a colour
    datasetFill : true,

    animationSteps : 75,
    // Boolean - If we want to override with a hard coded scale
    scaleOverride: true,

    scaleFontSize: 13,
 
    scaleLabel : " <%= !Number(value) ? '' :  Number(value)%>",

    // ** Required if scaleOverride is true **
    // Number - The number of steps in a hard coded scale
    scaleSteps: 12,
    // Number - The value jump in the hard coded scale
    scaleStepWidth: Math.floor(scaleSteps / 12),
    // Number - The scale starting value
    scaleStartValue: 0,

  //String - A legend template
  legendTemplate: "<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<datasets.length; i++){%><li><span style=\"background-color:<%=datasets[i].lineColor%>\"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>"

}

setScale();

function setScale() {
  _labels = [];

  if(scale == "week") {
    for (i = 0; i <= 6; i++) {
      _labels.push(now.getMonth() + 1 + "/" + (now.addDays(i).getDate()));
    }
    options.scaleStepWidth = Math.ceil((Math.max.apply(Math, metricsData.datasets[0].data) * 1.5)/12);
  } else {
    for (i = 0; i <= numberOfDaysInMonth() - 1; i++) {
      _labels.push(now.getMonth() + 1 + "/" + (now.getDate() + i));
    }
    options.scaleStepWidth = Math.ceil((Math.max.apply(Math, metricsData.datasets[0].data) * 1.5)/12);
  }

  metricsData.labels = _labels
}

// function getTeamWeekData() {
//   total = 0;
//   _data.impact_metrics.orders[(now.getYear() + 1900) + "W" + now.getWeek()].forEach(function(user){
//     users.orders.forEach(function(order){
//       if(order){

//       }
//     })
//   })
//   return total;
// }

function setCalendarWeek(){
  daysFromSun = now.getDay()
  return new Date(now.setDate(now.getDate() - daysFromSun))
}

function setCalendarMonth(){
  return now.setDate(1);
}

function numberOfDaysInMonth(){
  days = new Date(now);
  days = new Date(days.setMonth(now.getMonth() + 1));
  return (new Date(days.setDate(0))).getDate();
} 

function randomizeData(length){
  total = 0;
  metricsData.datasets[0].data = []
  for(i = 0; i <= length; i++) {
    metricsData.datasets[0].data.push(Math.floor(Math.random() * 5 + 1));
  }
}

var ctx = $("#metricsChart").get(0).getContext("2d");
var myChart = new Chart(ctx).Line(metricsData, options);

//TIME FUNCTIONS
displayWeek()

  $('.back').on("click", function(){
    if(scale == "month"){
      monthBack()
      displayMonth()
      myChart.destroy();
      randomizeData(29)
      setScale() 
      ctx.canvas.width = 670 
      ctx.canvas.height = 330 
      myChart = new Chart(ctx).Line(metricsData, options);
    } else {
      weekBack()
      displayWeek()
      setScale() 
      myChart.destroy();
      randomizeData(6)
      setScale()
      ctx.canvas.width = 670 
      ctx.canvas.height = 330  
      myChart = new Chart(ctx).Line(metricsData, options);
    }
  })

  $('.forward').on("click", function(){
    if(scale == "month"){
      monthForward()
      displayMonth()
      setScale() 
      myChart.destroy();
      randomizeData(29)
      ctx.canvas.width = 670 
      ctx.canvas.height = 330 
      myChart = new Chart(ctx).Line(metricsData, options);
    } else {
      weekForward()
      displayWeek()
      setScale() 
      myChart.destroy();
      randomizeData(6)
      ctx.canvas.width = 670 
      ctx.canvas.height = 330 
      myChart = new Chart(ctx).Line(metricsData, options);
    }
  })

  function weekOfMonth(){
    return Math.ceil(now.getDate()/7);
  }

  function weekBack() {
    now = new Date(now.setDate(now.getDate() - 7))
  }

  function weekForward() {
    now = new Date(now.setDate(now.getDate() + 7))
  }

  function displayWeek(){
    $(".week-span").html("WEEK " + now.getWeek());
  }

  function monthBack() {
    now = new Date(now.setMonth(now.getMonth() - 1))
  }

  function monthForward() {
    now = new Date(now.setMonth(now.getMonth() + 1))
  }

  function displayMonth(){
    $(".week-span").html($.datepicker.formatDate('MM', now));
  }

$(".return_to_team").on("click",function(e){
  myChart.destroy();
  randomizeData(29)
  setScale()
  ctx.canvas.width = 670 
  ctx.canvas.height = 330 
  myChart = new Chart(ctx).Line(metricsData, options);  
    $("#graph_title").html("Total Earnings to Date");
    $(".contributor").css("background","#545454");
    $(".return_to_team").hide();
    $(".progress_description").fadeIn();
    currentlyViewing="team";
});

//FOR DEMO (DELETE AFTER)
$(".current").on("click", function(e){
    now = new Date()
    if(scale == "week") displayWeek()
    if(scale == "month") displayMonth()
    myChart.destroy();
    randomizeData(29)
    setScale()
    ctx.canvas.width = 670 
    ctx.canvas.height = 330 
    myChart = new Chart(ctx).Line(metricsData, options); 
})

$(".time_scale .month").on("click", function() {
  options.barValueSpacing = 3;
  setCalendarMonth()
  displayMonth()
  scale = "month"
  myChart.destroy();
  randomizeData(29)
  setScale()
  ctx.canvas.width = 670 
  ctx.canvas.height = 330 
  myChart = new Chart(ctx).Line(metricsData, options);
  
  $(".time_scale .week").removeClass("active");
  $(this).addClass("active");
})

$(".time_scale .week").on("click", function() {
  options.barValueSpacing = 20;
  setCalendarWeek()
  displayWeek()
  scale = "week"
  myChart.destroy();
  randomizeData(6)
  setScale()
  ctx.canvas.width = 670 
  ctx.canvas.height = 330 
  myChart = new Chart(ctx).Line(metricsData, options);
 
  $(".time_scale .month").removeClass("active");
  $(this).addClass("active");
})

 // $('.page-count').html(page + " of " + total_pages);

// PAGINATION FOR USERS
  $('.fa-caret-down').show();
  $('.fa-caret-down').on("click", function(e) {
    $('.contributor').each(function(){
      $(this).velocity({backgroundColor:"#545454"},100);
    })
    if($('.fa-caret-down').hasClass("active")){
      e.preventDefault();
      e.stopPropagation();
      page += 1
      // $('.page-count').html(page + " of " + total_pages);
      checkPage()
      position -= 406;
      $('.contributor').each(function() {
        $(this).velocity({translateY: position + "px"});
      })
    }
  });

  $('.fa-caret-up').on("click", function(e) {
    $('.contributor').each(function(){
      $(this).velocity({backgroundColor:"#545454"},100);
    })
      if($('.fa-caret-up').hasClass("active")){
        e.preventDefault();
        e.stopPropagation();
        page -= 1;
        // $('.page-count').html(page + " of " + total_pages);
        checkPage();
        position += 406;
        $('.contributor').each(function() {
          $(this).velocity({translateY: position + "px"});
        })
      };
    });


function checkPage(){
  if (page != 1) {
    $('.fa-caret-up').css("opacity","1");
    $('.fa-caret-up').addClass("active");
  } else {
    $('.fa-caret-up').css("opacity","0.3");
    $('.fa-caret-up').removeClass("active");
  }

  if (page !=  2) {
    $('.fa-caret-down').css("opacity","1");
    $('.fa-caret-down').addClass("active");
  } else {
    $('.fa-caret-down').css("opacity","0.3");
    $('.fa-caret-down').removeClass("active");
  }
}

checkPage()

//////////////////////////

function contributorEvents(){

  $(".contributor").on("click", function(e) {
    e.preventDefault();
    e.stopPropagation();
    $(".return_to_team").fadeIn();
    _index=$(this).find(".avatar").attr("id").replace("avatar","")-1;
    $(".progress_description").hide();
    $('.contributor').each(function(){
      $(this).velocity({backgroundColor:"#545454"},100);
    })
    $(this).velocity({backgroundColor:"#333"},100);

    currentlyViewing = "individuals";

    options.animationSteps = 20;
    myChart.destroy();
    randomizeData(29)
    setScale()
    ctx.canvas.width = 670 
    ctx.canvas.height = 330 
    myChart = new Chart(ctx).Line(metricsData, options);
    $("#graph_title").html($(this).attr('id') + "'s Earnings to Date")
  });

  $(".contributor")
      .show()
      .velocity("transition.slideUpBigIn", { 
        stagger: 200, 
        duration: 600
      })
}

function numberWithCommas(x) {
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function randomizeOrders(){
  _data.team.entities.forEach(function(member){
    member.properties.orders = Math.floor(Math.random() * 30 + 10)
  });
}

function getAllOrders(){

  _data.team.entities.forEach(function(member){
    _endPoints.push({
      url:"/u/users/"+member.properties.id+"/orders",
      data:{},
      name:member.properties.email
    });
  });

  EyeCueLab.JSON.asynchronousLoader(_endPoints, function(_returnJSONs){
    var allOrders = [];
     _returnJSONs.forEach(function(member){
      member.entities.forEach(function(order){
        allOrders.push(order);
      });
    });
   _data.impact_metrics.orders = {"all": allOrders}
  });
  console.log("getAllOrders() finished; _data.impact_metrics.orders.all should be populated with all orders from your genealogy.")
}

getAllOrders();

//Orders Total for given week
function totalOrdersForWeek(){
  var _ordersCounter = 0;
  _data.team.entities.forEach(function(member){
    _data.impact_metrics.push({"id": member.properties.id, "orders": member.properties.orders, "week": "this week"});
    _ordersCounter += member.properties.orders;
  })
  $(".totalOrdersForWeek").html(_ordersCounter);
  return _ordersCounter;
}

  //bringing in current user's downline on the left side of KPIs (andrew)

  function populateContributors() {
    var _contributors = $(".contributors");
    _contributors.html("");
    array = _data.team.entities.slice(0,10)

    array.forEach(function(member) {
      _ajax({
        _ajaxType: "get",
        _url: "/u/users/" + member.properties.id + "/downline",
        _callback: function(data, text) {
          console.log(data)
          member.properties.downline_count = data.entities.length;
          EyeCueLab.UX.getTemplate("/templates/_kpi_total_earnings_team_thumbnail.handlebars.html", member, undefined, function(html) {
          if($('.contributor').length == array.length) contributorEvents();
            _contributors.append(html);
          });
        }
      });
    });
  }

  randomizeOrders();
  // totalOrdersForWeek();
  populateContributors();

</script>


